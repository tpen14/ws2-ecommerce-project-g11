<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
     <link rel="icon" type="image/png" href="/images/chonccolate.png">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="register-page">
    <!-- Navigation Bar -->
    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <img src="/images/chonccolate.png" alt="Chonccolate" class="navbar-logo">
            Chonccolate
        </a>
        
        <button class="menu-toggle" id="menuToggle">â˜°</button>
        
        <ul class="navbar-links" id="navbarLinks">
            <li><a href="/">Home</a></li>
            <li><a href="/products">Products</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="/contact">Contact</a></li>
        </ul>
        
        <div class="auth-buttons" id="authButtons">
            <a href="/users/login" class="auth-button login">Login</a>
            <a href="/users/register" class="auth-button register active">Register</a>
        </div>
    </nav>

    <div class="register-container">
        <form action="/users/register" method="POST" id="registrationForm" class="form-card">
            <h2>Create Account</h2>
            <p class="form-subtitle">Join our community today</p>
            
            <% if (typeof error !== 'undefined' && error) { %>
                <div class="alert alert-danger">
                    <%= error %>
                </div>
            <% } %>

            <div class="form-row">
                <div class="form-group">
                    <label for="firstName">First Name</label>
                    <input type="text" id="firstName" name="firstName" value="<%= typeof firstName !== 'undefined' ? firstName : '' %>" required>
                </div>
                
                <div class="form-group">
                    <label for="lastName">Last Name</label>
                    <input type="text" id="lastName" name="lastName" value="<%= typeof lastName !== 'undefined' ? lastName : '' %>" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" value="<%= typeof email !== 'undefined' ? email : '' %>" required>
            </div>
            
            <div class="form-group password-field">
                <label for="password">Password</label>
                <div class="password-input-wrapper">
                    <input type="password" id="password" name="password" required>
                    <button type="button" class="toggle-password" data-target="password">Show</button>
                </div>
                
                <div class="password-criteria">
                    <div class="criteria-item" id="length">At least 8 characters</div>
                    <div class="criteria-item" id="uppercase">Includes uppercase letter</div>
                    <div class="criteria-item" id="lowercase">Includes lowercase letter</div>
                    <div class="criteria-item" id="number">Includes at least one number</div>
                    <div class="criteria-item" id="special">Includes at least one special character</div>
                </div>
            </div>
            
            <div class="form-group password-field">
                <label for="confirmPassword">Confirm Password</label>
                <div class="password-input-wrapper">
                    <input type="password" id="confirmPassword" name="confirmPassword" required>
                    <button type="button" class="toggle-password" data-target="confirmPassword">Show</button>
                </div>
                <div class="password-match-message" id="passwordMatch"></div>
            </div> 
            
            <div class="form-group">
                <label for="contactNumber">Contact Number</label>
                <input type="tel" id="contactNumber" name="contactNumber" pattern="^(?:\+63|0)9[0-9]{9}$" placeholder="e.g. 09171234567 or +639171234567" value="<%= typeof contactNumber !== 'undefined' ? contactNumber : '' %>">
                <div class="help-text">Format: 09XXXXXXXXX or +639XXXXXXXXX</div>
            </div>

            <div class="form-group">
                <label for="region">Region</label>
                <select id="region" name="region">
                    <option value="">Select Region</option>
                </select>
            </div>

            <div class="form-group">
                <label for="province">Province</label>
                <select id="province" name="province" disabled>
                    <option value="">Select Province</option>
                </select>
            </div>

            <div class="form-group">
                <label for="city">City/Municipality</label>
                <select id="city" name="city" disabled>
                    <option value="">Select City/Municipality</option>
                </select>
            </div>

            <div class="form-group">
                <label for="barangay">Barangay</label>
                <select id="barangay" name="barangay" disabled>
                    <option value="">Select Barangay</option>
                </select>
            </div>

            <div class="form-group">
                <label for="street">Street/Building/Unit</label>
                <input type="text" id="street" name="street" placeholder="e.g. 123 Main Street, Bldg 5, Unit 201" value="">
            </div>

            <!-- Turnstile widget -->
            <div class="cf-turnstile" data-sitekey="<%= process.env.TURNSTILE_SITEKEY %>"></div>
            <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
           
            <div class="form-actions">
                <button type="submit" id="submitBtn" class="primary-button">Register</button>
            </div>
            
            <div class="form-links">
                <p>Already have an account? <a href="/users/login">Login here</a></p>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const form = document.getElementById('registrationForm');
            const toggleButtons = document.querySelectorAll('.toggle-password');
            const submitBtn = document.getElementById('submitBtn');
            
            // Menu toggle
            document.getElementById('menuToggle').addEventListener('click', function() {
                document.getElementById('navbarLinks').classList.toggle('active');
                document.getElementById('authButtons').classList.toggle('active');
            });
            
            // Password visibility toggle
            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const inputField = document.getElementById(targetId);
                    
                    if (inputField.type === 'password') {
                        inputField.type = 'text';
                        this.textContent = 'Hide';
                    } else {
                        inputField.type = 'password';
                        this.textContent = 'Show';
                    }
                });
            });
            
            // Password validation criteria
            const criteria = {
                length: { regex: /.{8,}/, element: document.getElementById('length') },
                uppercase: { regex: /[A-Z]/, element: document.getElementById('uppercase') },
                lowercase: { regex: /[a-z]/, element: document.getElementById('lowercase') },
                number: { regex: /[0-9]/, element: document.getElementById('number') },
                special: { regex: /[!@#$%^&*(),.?":{}|<>]/, element: document.getElementById('special') }
            };
            
            // Password validation
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                let isValid = true;
                
                // Check each criteria
                for (const key in criteria) {
                    const isMatch = criteria[key].regex.test(password);
                    if (isMatch) {
                        criteria[key].element.classList.add('valid');
                    } else {
                        criteria[key].element.classList.remove('valid');
                        isValid = false;
                    }
                }
                
                // Check if passwords match
                if (confirmPasswordInput.value) {
                    validatePasswordMatch();
                }
                
                // Enable or disable submit button
                updateSubmitButton();
            });
            
            // Password match validation
            function validatePasswordMatch() {
                const passwordMatch = document.getElementById('passwordMatch');
                if (passwordInput.value === confirmPasswordInput.value) {
                    passwordMatch.textContent = 'Passwords match';
                    passwordMatch.style.color = 'var(--lol-green)';
                    return true;
                } else {
                    passwordMatch.textContent = 'Passwords do not match';
                    passwordMatch.style.color = 'var(--lol-red)';
                    return false;
                }
            }
            
            confirmPasswordInput.addEventListener('input', function() {
                validatePasswordMatch();
                updateSubmitButton();
            });
            
            // Update submit button state
            function updateSubmitButton() {
                // Check password criteria
                let passwordIsValid = true;
                for (const key in criteria) {
                    if (!criteria[key].regex.test(passwordInput.value)) {
                        passwordIsValid = false;
                        break;
                    }
                }
                
                // Check password match
                const passwordsMatch = passwordInput.value === confirmPasswordInput.value;
                
                // Enable/disable button
                submitBtn.disabled = !(passwordIsValid && passwordsMatch);
            }
            
            // Form submission validation
            form.addEventListener('submit', function(e) {
                // Check password strength
                let passwordIsValid = true;
                for (const key in criteria) {
                    if (!criteria[key].regex.test(passwordInput.value)) {
                        passwordIsValid = false;
                        break;
                    }
                }
                
                // Check password match
                const passwordsMatch = passwordInput.value === confirmPasswordInput.value;
                
                if (!passwordIsValid || !passwordsMatch) {
                    e.preventDefault();
                    alert('Please ensure your password meets all criteria and both passwords match.');
                }
            });

            // Philippine Address Cascading Dropdowns
            let regions = [];
            let provinces = [];
            let cities = [];
            let barangays = [];

            const regionSelect = document.getElementById('region');
            const provinceSelect = document.getElementById('province');
            const citySelect = document.getElementById('city');
            const barangaySelect = document.getElementById('barangay');

            // Load all JSON data
            async function loadAddressData() {
                try {
                    const [regionsData, provincesData, citiesData, barangaysData] = await Promise.all([
                        fetch('/Addresses/region.json').then(r => r.json()),
                        fetch('/Addresses/province.json').then(r => r.json()),
                        fetch('/Addresses/city.json').then(r => r.json()),
                        fetch('/Addresses/barangay.json').then(r => r.json())
                    ]);

                    regions = regionsData;
                    provinces = provincesData;
                    cities = citiesData;
                    barangays = barangaysData;

                    populateRegions();
                } catch (error) {
                    console.error('Error loading address data:', error);
                }
            }

            function populateRegions() {
                regionSelect.innerHTML = '<option value="">Select Region</option>';
                regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region.region_name;
                    option.setAttribute('data-code', region.region_code);
                    option.textContent = region.region_name;
                    regionSelect.appendChild(option);
                });
            }

            function populateProvinces(regionCode) {
                provinceSelect.innerHTML = '<option value="">Select Province</option>';
                provinceSelect.disabled = false;
                citySelect.innerHTML = '<option value="">Select City/Municipality</option>';
                citySelect.disabled = true;
                barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
                barangaySelect.disabled = true;

                const filteredProvinces = provinces.filter(p => p.region_code === regionCode);
                filteredProvinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.province_name;
                    option.setAttribute('data-code', province.province_code);
                    option.textContent = province.province_name;
                    provinceSelect.appendChild(option);
                });
            }

            function populateCities(provinceCode) {
                citySelect.innerHTML = '<option value="">Select City/Municipality</option>';
                citySelect.disabled = false;
                barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
                barangaySelect.disabled = true;

                const filteredCities = cities.filter(c => c.province_code === provinceCode);
                filteredCities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.city_name;
                    option.setAttribute('data-code', city.city_code);
                    option.textContent = city.city_name;
                    citySelect.appendChild(option);
                });
            }

            function populateBarangays(cityCode) {
                barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
                barangaySelect.disabled = false;

                const filteredBarangays = barangays.filter(b => b.city_code === cityCode);
                filteredBarangays.forEach(barangay => {
                    const option = document.createElement('option');
                    option.value = barangay.brgy_name;
                    option.setAttribute('data-code', barangay.brgy_code);
                    option.textContent = barangay.brgy_name;
                    barangaySelect.appendChild(option);
                });
            }

            regionSelect.addEventListener('change', function() {
                if (this.value) {
                    const selectedOption = this.options[this.selectedIndex];
                    const regionCode = selectedOption.getAttribute('data-code');
                    populateProvinces(regionCode);
                } else {
                    provinceSelect.innerHTML = '<option value="">Select Province</option>';
                    provinceSelect.disabled = true;
                    citySelect.innerHTML = '<option value="">Select City/Municipality</option>';
                    citySelect.disabled = true;
                    barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
                    barangaySelect.disabled = true;
                }
            });

            provinceSelect.addEventListener('change', function() {
                if (this.value) {
                    const selectedOption = this.options[this.selectedIndex];
                    const provinceCode = selectedOption.getAttribute('data-code');
                    populateCities(provinceCode);
                } else {
                    citySelect.innerHTML = '<option value="">Select City/Municipality</option>';
                    citySelect.disabled = true;
                    barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
                    barangaySelect.disabled = true;
                }
            });

            citySelect.addEventListener('change', function() {
                if (this.value) {
                    const selectedOption = this.options[this.selectedIndex];
                    const cityCode = selectedOption.getAttribute('data-code');
                    populateBarangays(cityCode);
                } else {
                    barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
                    barangaySelect.disabled = true;
                }
            });

            // Load address data on page load
            loadAddressData();
        });
    </script>
</body>
</html>