<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title><%= title %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <!-- Navigation Bar -->
    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <img src="/images/chonccolate.png" alt="Chonccolate" class="navbar-logo">
            Chonccolate
        </a>
        
        <ul class="navbar-links" id="navbarLinks">
            <li><a href="/" class="active">Home</a></li>
            <li><a href="/products">Products</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="/contact">Contact</a></li>

            <% if (locals.user && locals.user.role === 'customer') { %>
              <li><a href="/cart">Cart</a></li>
            <% } %>

            <% if (locals.user && (locals.user.role === 'admin' || locals.user.role === 'customer')) { %>
              <li><a href="/orders">Orders</a></li>
            <% } %>
        </ul>
        <div class="auth-buttons" id="authButtons">
            <% if (locals.user) { %>
                <a href="/users/dashboard" class="auth-button login">Dashboard</a>
                <a href="/users/logout" class="auth-button register">Logout</a>
            <% } else { %>
                <a href="/users/login" class="auth-button login">Login</a>
                <a href="/users/register" class="auth-button register">Register</a>
            <% } %>
        </div>
    </nav>

  <main class="main-content">
    <div class="products-container">
      <div class="dashboard-header">
        <h1>Edit Profile</h1>
        <a href="/users/dashboard" class="back-link">‚Üê Back to Dashboard</a>
      </div>

      <% if (typeof success !== 'undefined' && success) { %>
        <div id="profileSuccess" class="alert alert-success"><%= success %></div>
      <% } %>
      <% if (typeof error !== 'undefined' && error) { %>
        <div id="profileError" class="alert alert-danger"><%= error %></div>
      <% } %>

      <div class="user-info-card">
        <form action="/users/profile" method="POST">
          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First Name</label>
              <input type="text" id="firstName" name="firstName" value="<%= user.firstName %>" required>
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input type="text" id="lastName" name="lastName" value="<%= user.lastName %>" required>
            </div>
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" value="<%= user.email %>" required>
          </div>

          <div class="form-group">
            <label for="contactNumber">Contact Number</label>
            <input type="tel" id="contactNumber" name="contactNumber" pattern="^(\+63|0)9[0-9]{9}$" placeholder="e.g. 09171234567 or +639171234567" value="<%= user.contactNumber || '' %>">
            <div class="help-text">Format: 09XXXXXXXXX or +639XXXXXXXXX</div>
          </div>

          <div class="form-group">
            <label for="region">Region</label>
            <select id="region" name="region">
              <option value="">Select Region</option>
            </select>
          </div>

          <div class="form-group">
            <label for="province">Province</label>
            <select id="province" name="province" disabled>
              <option value="">Select Province</option>
            </select>
          </div>

          <div class="form-group">
            <label for="city">City/Municipality</label>
            <select id="city" name="city" disabled>
              <option value="">Select City/Municipality</option>
            </select>
          </div>

          <div class="form-group">
            <label for="barangay">Barangay</label>
            <select id="barangay" name="barangay" disabled>
              <option value="">Select Barangay</option>
            </select>
          </div>

          <div class="form-group">
            <label for="street">Street/Building/Unit</label>
            <input type="text" id="street" name="street" placeholder="e.g. 123 Main Street, Bldg 5, Unit 201" value="<%= typeof user.address === 'object' && user.address.street ? user.address.street : '' %>">
          </div>

          <div class="form-actions">
            <button type="submit" id="saveBtn" class="primary-button">Save Changes</button>
            <a href="/users/dashboard" class="secondary-button">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </main>

     <footer class="footer">
    <div class="footer-container">

        
        <div class="footer-section">
            <h3>Quick Links</h3>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/products">Products</a></li>
                <li><a href="/about">About Us</a></li>
                <li><a href="/contact">Contact</a></li>
            </ul>
        </div>
        
        <div class="footer-section">
            <h3>Legal</h3>
            <ul>
                <li><a href="/terms">Terms of Service</a></li>
                <li><a href="/privacy">Privacy Policy</a></li>
                <li><a href="/return-policy">Return Policy</a></li>
            </ul>
        </div>
        
     
    <div class="footer-bottom">
        <p>&copy; <%= new Date().getFullYear() %> Chonccolate. All rights reserved.</p>
    </div>
</footer>

  <script>
    document.getElementById('menuToggle')?.addEventListener('click', function() {
      document.getElementById('navbarLinks')?.classList.toggle('active');
      document.getElementById('authButtons')?.classList.toggle('active');
    });

    // Philippine Address Cascading Dropdowns
      (function() {
        let regions = [];
        let provinces = [];
        let cities = [];
        let barangays = [];

        const regionSelect = document.getElementById('region');
        const provinceSelect = document.getElementById('province');
        const citySelect = document.getElementById('city');
        const barangaySelect = document.getElementById('barangay');

        // Existing address values from server
        const existingAddress = {
          region: '<%= typeof user.address === "object" && user.address.region ? user.address.region : "" %>',
          province: '<%= typeof user.address === "object" && user.address.province ? user.address.province : "" %>',
          city: '<%= typeof user.address === "object" && user.address.city ? user.address.city : "" %>',
          barangay: '<%= typeof user.address === "object" && user.address.barangay ? user.address.barangay : "" %>'
        };

        // Load all JSON data
        async function loadAddressData() {
          try {
            const [regionsData, provincesData, citiesData, barangaysData] = await Promise.all([
              fetch('/Addresses/region.json').then(r => r.json()),
              fetch('/Addresses/province.json').then(r => r.json()),
              fetch('/Addresses/city.json').then(r => r.json()),
              fetch('/Addresses/barangay.json').then(r => r.json())
            ]);

            regions = regionsData;
            provinces = provincesData;
            cities = citiesData;
            barangays = barangaysData;

            populateRegions();
            
            // Pre-populate existing values if they exist
            if (existingAddress.region) {
              regionSelect.value = existingAddress.region;
              const selectedRegionOption = Array.from(regionSelect.options).find(opt => opt.value === existingAddress.region);
              if (selectedRegionOption) {
                const regionCode = selectedRegionOption.getAttribute('data-code');
                populateProvinces(regionCode);
                
                setTimeout(() => {
                  if (existingAddress.province) {
                    provinceSelect.value = existingAddress.province;
                    const selectedProvinceOption = Array.from(provinceSelect.options).find(opt => opt.value === existingAddress.province);
                    if (selectedProvinceOption) {
                      const provinceCode = selectedProvinceOption.getAttribute('data-code');
                      populateCities(provinceCode);
                      
                      setTimeout(() => {
                        if (existingAddress.city) {
                          citySelect.value = existingAddress.city;
                          const selectedCityOption = Array.from(citySelect.options).find(opt => opt.value === existingAddress.city);
                          if (selectedCityOption) {
                            const cityCode = selectedCityOption.getAttribute('data-code');
                            populateBarangays(cityCode);
                            
                            setTimeout(() => {
                              if (existingAddress.barangay) {
                                barangaySelect.value = existingAddress.barangay;
                              }
                            }, 50);
                          }
                        }
                      }, 50);
                    }
                  }
                }, 50);
              }
            }
          } catch (error) {
            console.error('Error loading address data:', error);
          }
        }

        function populateRegions() {
          regionSelect.innerHTML = '<option value="">Select Region</option>';
          regions.forEach(region => {
            const option = document.createElement('option');
            option.value = region.region_name; // Changed from region_code to region_name
            option.setAttribute('data-code', region.region_code);
            option.textContent = region.region_name;
            regionSelect.appendChild(option);
          });
        }

        function populateProvinces(regionCode) {
          provinceSelect.innerHTML = '<option value="">Select Province</option>';
          provinceSelect.disabled = false;
          citySelect.innerHTML = '<option value="">Select City/Municipality</option>';
          citySelect.disabled = true;
          barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
          barangaySelect.disabled = true;

          const filteredProvinces = provinces.filter(p => p.region_code === regionCode);
          filteredProvinces.forEach(province => {
            const option = document.createElement('option');
            option.value = province.province_name; // Changed from province_code to province_name
            option.setAttribute('data-code', province.province_code);
            option.textContent = province.province_name;
            provinceSelect.appendChild(option);
          });
        }

        function populateCities(provinceCode) {
          citySelect.innerHTML = '<option value="">Select City/Municipality</option>';
          citySelect.disabled = false;
          barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
          barangaySelect.disabled = true;

          const filteredCities = cities.filter(c => c.province_code === provinceCode);
          filteredCities.forEach(city => {
            const option = document.createElement('option');
            option.value = city.city_name; // Changed from city_code to city_name
            option.setAttribute('data-code', city.city_code);
            option.textContent = city.city_name;
            citySelect.appendChild(option);
          });
        }

        function populateBarangays(cityCode) {
          barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
          barangaySelect.disabled = false;

          const filteredBarangays = barangays.filter(b => b.city_code === cityCode);
          filteredBarangays.forEach(barangay => {
            const option = document.createElement('option');
            option.value = barangay.brgy_name; // Changed from brgy_code to brgy_name
            option.setAttribute('data-code', barangay.brgy_code);
            option.textContent = barangay.brgy_name;
            barangaySelect.appendChild(option);
          });
        }

        regionSelect.addEventListener('change', function() {
          if (this.value) {
            const selectedOption = this.options[this.selectedIndex];
            const regionCode = selectedOption.getAttribute('data-code');
            populateProvinces(regionCode);
          } else {
            provinceSelect.innerHTML = '<option value="">Select Province</option>';
            provinceSelect.disabled = true;
            citySelect.innerHTML = '<option value="">Select City/Municipality</option>';
            citySelect.disabled = true;
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
            barangaySelect.disabled = true;
          }
        });

        provinceSelect.addEventListener('change', function() {
          if (this.value) {
            const selectedOption = this.options[this.selectedIndex];
            const provinceCode = selectedOption.getAttribute('data-code');
            populateCities(provinceCode);
          } else {
            citySelect.innerHTML = '<option value="">Select City/Municipality</option>';
            citySelect.disabled = true;
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
            barangaySelect.disabled = true;
          }
        });

        citySelect.addEventListener('change', function() {
          if (this.value) {
            const selectedOption = this.options[this.selectedIndex];
            const cityCode = selectedOption.getAttribute('data-code');
            populateBarangays(cityCode);
          } else {
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
            barangaySelect.disabled = true;
          }
        });

        // Load data on page load
        loadAddressData();

        // Auto-hide success message after 4s
        const successEl = document.getElementById('profileSuccess');
        if (successEl) setTimeout(()=>{ successEl.style.display='none'; }, 4000);

        // Client-side contact number validation on submit
        const form = document.querySelector('form[action="/users/profile"]');
        const contactInput = document.getElementById('contactNumber');
        const profileError = document.getElementById('profileError');
        const phRegex = /^(?:\+63|0)9\d{9}$/;

        if (form && contactInput) {
          form.addEventListener('submit', function(e){
            const val = (contactInput.value || '').trim();
            if (val && !phRegex.test(val)) {
              e.preventDefault();
              if (profileError) {
                profileError.textContent = 'Contact number format is invalid. Use 09XXXXXXXXX or +639XXXXXXXXX.';
                profileError.style.display = 'block';
              } else {
                alert('Contact number format is invalid. Use 09XXXXXXXXX or +639XXXXXXXXX.');
              }
              contactInput.focus();
              return false;
            }
          });
        }
      })();
  </script>
</body>
</html>
