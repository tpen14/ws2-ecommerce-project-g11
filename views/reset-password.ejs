<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <img src="/images/chonccolate.png" alt="Chonccolate" class="navbar-logo">
            Chonccolate
        </a>
        
        <ul class="navbar-links" id="navbarLinks">
            <li><a href="/" class="active">Home</a></li>
            <li><a href="/products">Products</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="/contact">Contact</a></li>

            <% if (locals.user && locals.user.role === 'customer') { %>
              <li><a href="/cart">Cart</a></li>
            <% } %>

            <% if (locals.user && (locals.user.role === 'admin' || locals.user.role === 'customer')) { %>
              <li><a href="/orders">Orders</a></li>
            <% } %>
        </ul>
        <div class="auth-buttons" id="authButtons">
            <% if (locals.user) { %>
                <a href="/users/dashboard" class="auth-button login">Dashboard</a>
                <a href="/users/logout" class="auth-button register">Logout</a>
            <% } else { %>
                <a href="/users/login" class="auth-button login">Login</a>
                <a href="/users/register" class="auth-button register">Register</a>
            <% } %>
        </div>
    </nav>

    <div class="login-container">
        <form action="/password/reset/<%= token %>" method="POST">
            <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger">
                <%= error %>
            </div>
            <% } %>
            
            <h2>Reset Password</h2>
            <p>Please create a new secure password for your account.</p>
            
            <div class="password-field">
                <label for="password">New Password:</label>
                <div class="password-input-wrapper">
                    <input type="password" id="password" name="password" required>
                    <button type="button" class="toggle-password" id="togglePassword">Show</button>
                </div>
                <div class="password-criteria">
                    <div class="criteria-item" id="lengthCriteria">At least 8 characters</div>
                    <div class="criteria-item" id="upperCriteria">At least one uppercase letter</div>
                    <div class="criteria-item" id="lowerCriteria">At least one lowercase letter</div>
                    <div class="criteria-item" id="numberCriteria">At least one number</div>
                    <div class="criteria-item" id="specialCriteria">At least one special character</div>
                </div>
            </div>
            
            <div class="password-field">
                <label for="confirm">Confirm Password:</label>
                <div class="password-input-wrapper">
                    <input type="password" id="confirm" name="confirm" required>
                    <button type="button" class="toggle-password" id="toggleConfirm">Show</button>
                </div>
                <div class="password-match-message" id="passwordMatch"></div>
            </div>
             <!-- Turnstile widget -->
            <div class="cf-turnstile" data-sitekey="<%= process.env.TURNSTILE_SITEKEY %>"></div>
            <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
            <button type="submit" id="resetBtn" disabled>Reset Password</button>
            
            <p><a href="/users/login">Back to Login</a></p>
        </form>
    </div>

    <!-- JavaScript for mobile menu toggle and password validation -->
    <script>
        document.getElementById('menuToggle').addEventListener('click', function() {
            document.getElementById('navbarLinks').classList.toggle('active');
            document.getElementById('authButtons').classList.toggle('active');
        });
        
        // Password toggle functionality
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                this.textContent = 'Hide';
            } else {
                passwordInput.type = 'password';
                this.textContent = 'Show';
            }
        });
        
        document.getElementById('toggleConfirm').addEventListener('click', function() {
            const confirmInput = document.getElementById('confirm');
            if (confirmInput.type === 'password') {
                confirmInput.type = 'text';
                this.textContent = 'Hide';
            } else {
                confirmInput.type = 'password';
                this.textContent = 'Show';
            }
        });
        
        // Password validation
        const password = document.getElementById('password');
        const confirm = document.getElementById('confirm');
        const resetBtn = document.getElementById('resetBtn');
        const lengthCriteria = document.getElementById('lengthCriteria');
        const upperCriteria = document.getElementById('upperCriteria');
        const lowerCriteria = document.getElementById('lowerCriteria');
        const numberCriteria = document.getElementById('numberCriteria');
        const specialCriteria = document.getElementById('specialCriteria');
        const passwordMatch = document.getElementById('passwordMatch');
        
        function validatePassword() {
            const passwordValue = password.value;
            
            // Check length
            if (passwordValue.length >= 8) {
                lengthCriteria.classList.add('valid');
            } else {
                lengthCriteria.classList.remove('valid');
            }
            
            // Check uppercase
            if (/[A-Z]/.test(passwordValue)) {
                upperCriteria.classList.add('valid');
            } else {
                upperCriteria.classList.remove('valid');
            }
            
            // Check lowercase
            if (/[a-z]/.test(passwordValue)) {
                lowerCriteria.classList.add('valid');
            } else {
                lowerCriteria.classList.remove('valid');
            }
            
            // Check number
            if (/[0-9]/.test(passwordValue)) {
                numberCriteria.classList.add('valid');
            } else {
                numberCriteria.classList.remove('valid');
            }
            
            // Check special character
            if (/[!@#$%^&*(),.?":{}|<>]/.test(passwordValue)) {
                specialCriteria.classList.add('valid');
            } else {
                specialCriteria.classList.remove('valid');
            }
            
            checkPasswordMatch();
        }
        
        function checkPasswordMatch() {
            if (password.value && confirm.value) {
                if (password.value === confirm.value) {
                    passwordMatch.textContent = 'Passwords match';
                    passwordMatch.style.color = '#155724';
                } else {
                    passwordMatch.textContent = 'Passwords do not match';
                    passwordMatch.style.color = '#721c24';
                }
            } else {
                passwordMatch.textContent = '';
            }
            
            // Enable submit button if all criteria are met and passwords match
            const allCriteriaMet = [
                lengthCriteria, upperCriteria, lowerCriteria, numberCriteria, specialCriteria
            ].every(item => item.classList.contains('valid'));
            
            resetBtn.disabled = !(allCriteriaMet && password.value === confirm.value);
        }
        
        password.addEventListener('input', validatePassword);
        confirm.addEventListener('input', checkPasswordMatch);
    </script>
</body>
</html>